<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAML Assertion ì „ì†¡</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
            width: 100%;
            max-width: 600px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }
        .info-box {
            background: #f0f7ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SAML Assertion ì „ì†¡</h1>
        <p class="subtitle">Microsoft Entra IDë¡œ ì¸ì¦ ì •ë³´ ì „ì†¡ ì¤‘...</p>
        
        <div class="info-box">
            <strong>ë™ì‘ ì„¤ëª…:</strong><br>
            ë¡œê·¸ì¸ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤. ì´ì œ SAML Responseë¥¼ Microsoft Entra IDë¡œ ìë™ ì „ì†¡í•©ë‹ˆë‹¤.
            ì´ í˜ì´ì§€ëŠ” ìë™ìœ¼ë¡œ Microsoft Entra IDì˜ Assertion Consumer Serviceë¡œ POST ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
        </div>
        
        <div class="loading">
            <div class="spinner"></div>
            <p class="message">Microsoft Entra IDë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¤‘...</p>
        </div>
        
        <!-- SAML Responseë¥¼ Microsoft Entra IDë¡œ POST ì „ì†¡ -->
        <!-- Thymeleafê°€ Base64 ë¬¸ìì—´ì„ ì´ìŠ¤ì¼€ì´í”„í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, JavaScriptì—ì„œ ì§ì ‘ ì„¤ì • -->
        <form id="samlForm" method="post" style="display: none;" enctype="application/x-www-form-urlencoded">
            <input type="hidden" name="SAMLResponse" id="samlResponseInput" value="">
            <input type="hidden" name="RelayState" id="relayStateInput" value="">
        </form>
        
        <!-- ì„œë²„ì—ì„œ ë°›ì€ ê°’ì„ JavaScript ë³€ìˆ˜ë¡œ ì „ë‹¬ (data ì†ì„± ì‚¬ìš©) -->
        <div id="samlData" 
             th:data-acs-url="${acsUrl}"
             th:data-saml-response="${samlResponse}"
             th:data-relay-state="${relayState}"
             style="display: none;"></div>
        
        <!-- ë””ë²„ê¹…ìš© ìˆ˜ë™ ì œì¶œ ë²„íŠ¼ (ìë™ ì œì¶œ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©) -->
        <div id="manualSubmit" style="display: none; margin-top: 20px; text-align: center;">
            <button onclick="submitForm()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ìˆ˜ë™ìœ¼ë¡œ ì œì¶œí•˜ê¸°
            </button>
        </div>
        
        <script th:inline="javascript">
            // ì„œë²„ì—ì„œ ë°›ì€ ê°’ ê°€ì ¸ì˜¤ê¸° (data ì†ì„±ì—ì„œ)
            var samlDataElement = document.getElementById('samlData');
            var acsUrl = samlDataElement ? samlDataElement.getAttribute('data-acs-url') : '';
            var samlResponse = samlDataElement ? samlDataElement.getAttribute('data-saml-response') : '';
            var relayState = samlDataElement ? samlDataElement.getAttribute('data-relay-state') : '';
            
            console.log('=== ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„° ===');
            console.log('ACS URL:', acsUrl);
            console.log('SAML Response ê¸¸ì´:', samlResponse ? samlResponse.length : 0);
            console.log('RelayState:', relayState);
            
            // í¼ ì œì¶œ í•¨ìˆ˜
            function submitForm() {
                try {
                    console.log('ğŸ“¤ í¼ ì œì¶œ ì‹œì‘...');
                    var form = document.getElementById('samlForm');
                    
                    if (!form) {
                        console.error('âŒ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                        alert('í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // í¼ action ì„¤ì •
                    if (acsUrl) {
                        form.action = acsUrl;
                    }
                    
                    // Hidden input í•„ë“œì— ê°’ ì„¤ì •
                    var responseInput = document.getElementById('samlResponseInput');
                    var relayStateInput = document.getElementById('relayStateInput');
                    
                    if (!responseInput) {
                        console.error('âŒ SAML Response inputì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                        alert('SAML Response inputì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    // ê°’ ì„¤ì •
                    responseInput.value = samlResponse || '';
                    if (relayStateInput) {
                        relayStateInput.value = relayState || '';
                    }
                    
                    // ì„¤ì •ëœ ê°’ í™•ì¸
                    var finalResponse = responseInput.value || '';
                    var finalRelayState = relayStateInput ? relayStateInput.value || '' : '';
                    
                    console.log('=== SAML Assertion ì „ì†¡ ë””ë²„ê¹… ===');
                    console.log('ACS URL:', form.action);
                    console.log('SAML Response ê¸¸ì´:', finalResponse ? finalResponse.length : 0);
                    console.log('SAML Response ì²˜ìŒ 100ì:', finalResponse ? finalResponse.substring(0, 100) : 'null');
                    console.log('RelayState:', finalRelayState);
                    console.log('Response Input ì¡´ì¬:', !!responseInput);
                    console.log('Response Input value íƒ€ì…:', typeof finalResponse);
                    
                    // SAML Responseê°€ ìˆëŠ”ì§€ í™•ì¸
                    if (!finalResponse || finalResponse.length === 0) {
                        console.error('âŒ SAML Responseê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!');
                        console.error('Response Input value:', finalResponse);
                        console.error('Response Input HTML:', responseInput.outerHTML);
                        console.error('ì„œë²„ì—ì„œ ë°›ì€ ì›ë³¸:', samlResponse);
                        alert('SAML Responseê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                        document.getElementById('manualSubmit').style.display = 'block';
                        return;
                    }
                    
                    if (finalResponse.length < 100) {
                        console.warn('âš ï¸ SAML Responseê°€ ë¹„ì •ìƒì ìœ¼ë¡œ ì§§ìŠµë‹ˆë‹¤:', finalResponse.length);
                    }
                    
                    // í¼ ë°ì´í„° í™•ì¸
                    var formData = new FormData(form);
                    console.log('FormData í™•ì¸:');
                    for (var pair of formData.entries()) {
                        var value = pair[1];
                        var preview = value ? (value.length > 50 ? value.substring(0, 50) + '...' : value) : 'null';
                        console.log('  ' + pair[0] + ':', preview, '(ê¸¸ì´: ' + (value ? value.length : 0) + ')');
                    }
                    
                    // Network íƒ­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ìƒì„¸ ë¡œê·¸
                    console.log('ğŸ“¡ POST ìš”ì²­ ì •ë³´:');
                    console.log('  URL:', form.action);
                    console.log('  Method: POST');
                    console.log('  Content-Type: application/x-www-form-urlencoded');
                    console.log('  SAMLResponse ê¸¸ì´:', finalResponse.length);
                    console.log('  RelayState:', finalRelayState);
                    
                    // ì‹¤ì œ ì „ì†¡ë  ë°ì´í„° í™•ì¸ (ì²˜ìŒ 200ìë§Œ)
                    var encodedResponse = encodeURIComponent(finalResponse);
                    console.log('  ì¸ì½”ë”©ëœ SAMLResponse ê¸¸ì´:', encodedResponse.length);
                    console.log('  ì¸ì½”ë”©ëœ SAMLResponse ì²˜ìŒ 200ì:', encodedResponse.substring(0, 200));
                    
                    console.log('âœ… í¼ ì œì¶œ ì‹¤í–‰...');
                    
                    form.submit();
                    
                } catch (error) {
                    console.error('âŒ í¼ ì œì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                    alert('í¼ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    document.getElementById('manualSubmit').style.display = 'block';
                }
            }
            
            // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ìë™ ì œì¶œ
            document.addEventListener('DOMContentLoaded', function() {
                console.log('ğŸ“„ DOM ë¡œë“œ ì™„ë£Œ');
                
                // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ëª¨ë“  ë¦¬ì†ŒìŠ¤ê°€ ë¡œë“œëœ í›„ ì œì¶œ
                setTimeout(function() {
                    submitForm();
                }, 500);
            });
            
            // window.onloadë„ ë°±ì—…ìœ¼ë¡œ ì‚¬ìš©
            window.addEventListener('load', function() {
                console.log('ğŸ“„ Window ë¡œë“œ ì™„ë£Œ');
                
                // DOMContentLoadedê°€ ì‹¤í–‰ë˜ì§€ ì•Šì€ ê²½ìš°ë¥¼ ëŒ€ë¹„
                setTimeout(function() {
                    var form = document.getElementById('samlForm');
                    if (form && !form.dataset.submitted) {
                        console.log('âš ï¸ DOMContentLoadedê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. window.onloadì—ì„œ ì œì¶œí•©ë‹ˆë‹¤.');
                        form.dataset.submitted = 'true';
                        submitForm();
                    }
                }, 2000);
            });
        </script>
    </div>
</body>
</html>

