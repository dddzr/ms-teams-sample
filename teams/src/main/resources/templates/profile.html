<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œí•„ - MS Teams API</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>
    <div class="header">
        <h1>ğŸ”· MS Teams API ëŒ€ì‹œë³´ë“œ</h1>
        <a href="/logout" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</a>
    </div>
    
    <div class="container">
        <div th:replace="~{fragments/menu :: menu}"></div>
        
        <!-- ì‚¬ìš©ì ì •ë³´ ì„¹ì…˜ -->
        <div class="section">
            <h2>ğŸ‘¤ ë‚´ ì •ë³´</h2>
            <button class="btn" onclick="loadUserInfo()">ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ</button>
            <button class="btn" onclick="showEditForm()">ì •ë³´ ìˆ˜ì •</button>
            <div id="userInfo"></div>
            <div id="userEditForm" style="display: none;"></div>
        </div>
    </div>
    
    <script th:replace="~{fragments/menu :: menu-script}"></script>
    <script>
        let currentUser = null;
        
        // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        async function loadUserInfo() {
            const container = document.getElementById('userInfo');
            const editForm = document.getElementById('userEditForm');
            container.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';
            editForm.style.display = 'none';
            
            try {
                const response = await fetch('/api/me');
                if (!response.ok) throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
                
                currentUser = await response.json();
                container.innerHTML = `
                    <div class="user-info">
                        <div class="info-item">
                            <label>ì´ë¦„</label>
                            <span>${currentUser.displayName || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì´ë©”ì¼</label>
                            <span>${currentUser.mail || currentUser.userPrincipalName || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì§ì±…</label>
                            <span>${currentUser.jobTitle || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ë¶€ì„œ</label>
                            <span>${currentUser.department || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì‚¬ë¬´ì‹¤</label>
                            <span>${currentUser.officeLocation || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì „í™”</label>
                            <span>${currentUser.businessPhones && currentUser.businessPhones.length > 0 ? currentUser.businessPhones[0] : 'N/A'}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<div class="error">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }
        
        // ìˆ˜ì • í¼ í‘œì‹œ
        async function showEditForm() {
            const container = document.getElementById('userInfo');
            const editForm = document.getElementById('userEditForm');
            
            // ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìœ¼ë©´ ë¨¼ì € ë¡œë“œ
            if (!currentUser) {
                await loadUserInfo();
            }
            
            editForm.innerHTML = `
                <div class="section" style="margin-top: 20px; background: #f9f9f9;">
                    <h3>ì •ë³´ ìˆ˜ì •</h3>
                    <div class="input-group">
                        <label style="width: 150px; display: inline-block;">ì´ë¦„:</label>
                        <input type="text" id="editDisplayName" value="${currentUser.displayName || ''}" style="flex: 1;">
                    </div>
                    <div class="input-group">
                        <label style="width: 150px; display: inline-block;">ì§ì±…:</label>
                        <input type="text" id="editJobTitle" value="${currentUser.jobTitle || ''}" style="flex: 1;">
                    </div>
                    <div class="input-group">
                        <label style="width: 150px; display: inline-block;">ë¶€ì„œ:</label>
                        <input type="text" id="editDepartment" value="${currentUser.department || ''}" style="flex: 1;">
                    </div>
                    <div class="input-group">
                        <label style="width: 150px; display: inline-block;">ì‚¬ë¬´ì‹¤:</label>
                        <input type="text" id="editOfficeLocation" value="${currentUser.officeLocation || ''}" style="flex: 1;">
                    </div>
                    <div class="input-group">
                        <label style="width: 150px; display: inline-block;">ì „í™”:</label>
                        <input type="text" id="editBusinessPhone" value="${currentUser.businessPhones && currentUser.businessPhones.length > 0 ? currentUser.businessPhones[0] : ''}" style="flex: 1;">
                    </div>
                    <div class="input-group">
                        <button class="btn" onclick="updateUserInfo()">ì €ì¥</button>
                        <button class="btn" onclick="cancelEdit()" style="background: #999;">ì·¨ì†Œ</button>
                    </div>
                    <div id="updateResult"></div>
                </div>
            `;
            editForm.style.display = 'block';
        }
        
        // ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •
        async function updateUserInfo() {
            const resultContainer = document.getElementById('updateResult');
            resultContainer.innerHTML = '<div class="loading">ì €ì¥ ì¤‘...</div>';
            
            try {
                // ë¹ˆ ë¬¸ìì—´ì€ nullë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡í•˜ì§€ ì•ŠìŒ
                const updateData = {};
                const displayName = document.getElementById('editDisplayName').value.trim();
                const jobTitle = document.getElementById('editJobTitle').value.trim();
                const department = document.getElementById('editDepartment').value.trim();
                const officeLocation = document.getElementById('editOfficeLocation').value.trim();
                const businessPhone = document.getElementById('editBusinessPhone').value.trim();
                
                if (displayName) updateData.displayName = displayName;
                if (jobTitle) updateData.jobTitle = jobTitle;
                if (department) updateData.department = department;
                if (officeLocation) updateData.officeLocation = officeLocation;
                if (businessPhone) updateData.businessPhone = businessPhone;
                
                // ì—…ë°ì´íŠ¸í•  í•„ë“œê°€ ì—†ìœ¼ë©´ ê²½ê³ 
                if (Object.keys(updateData).length === 0) {
                    resultContainer.innerHTML = '<div class="error">ìˆ˜ì •í•  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                const response = await fetch('/api/me', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                // ì‘ë‹µ ë³¸ë¬¸ í™•ì¸
                const responseText = await response.text();
                
                if (!response.ok) {
                    let errorMessage = 'API í˜¸ì¶œ ì‹¤íŒ¨';
                    try {
                        if (responseText) {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.message || errorMessage;
                        }
                    } catch (e) {
                        errorMessage = responseText || `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                // ì„±ê³µ ì‘ë‹µ ì²˜ë¦¬
                let updatedUser = null;
                if (responseText && responseText.trim()) {
                    try {
                        updatedUser = JSON.parse(responseText);
                        currentUser = updatedUser;
                    } catch (e) {
                        console.warn('ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨, ì‚¬ìš©ì ì •ë³´ ë‹¤ì‹œ ë¡œë“œ:', e);
                        // íŒŒì‹± ì‹¤íŒ¨í•´ë„ ì‚¬ìš©ì ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
                    }
                }
                
                resultContainer.innerHTML = '<div style="color: green; padding: 10px;">âœ… ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
                
                // 1ì´ˆ í›„ ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
                setTimeout(() => {
                    loadUserInfo();
                    document.getElementById('userEditForm').style.display = 'none';
                }, 1000);
                
            } catch (error) {
                resultContainer.innerHTML = `<div class="error">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }
        
        // ìˆ˜ì • ì·¨ì†Œ
        function cancelEdit() {
            document.getElementById('userEditForm').style.display = 'none';
            document.getElementById('updateResult').innerHTML = '';
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();
        });
    </script>
</body>
</html>

