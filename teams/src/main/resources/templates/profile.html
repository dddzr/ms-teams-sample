<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”„ë¡œí•„ - MS Teams API</title>
    <link rel="stylesheet" th:href="@{/css/common.css}">
</head>
<body>
    <div th:replace="~{fragments/menu :: header}"></div>
    
    <div class="container">
        <div th:replace="~{fragments/menu :: menu}"></div>
        
        <!-- ì‚¬ìš©ì ì •ë³´ ì„¹ì…˜ -->
        <div class="section">
            <h2>ğŸ‘¤ ë‚´ ì •ë³´</h2>
            <button class="btn" onclick="loadUserInfo()">ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ</button>
            <button class="btn" onclick="loadAppUserInfo()">ì•±(DB) ì •ë³´ ì¡°íšŒ</button>
            <button class="btn" onclick="showEditForm()">ì •ë³´ ìˆ˜ì •</button>
            <div id="userInfo"></div>
            <div id="appUserInfo"></div>
            <div id="userEditForm" style="display: none;"></div>
        </div>
    </div>
    
    <script th:replace="~{fragments/menu :: menu-script}"></script>
    <script>
        let msCurrentUser = null;
        
        // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        async function loadUserInfo() {
            const container = document.getElementById('userInfo');
            const appUserInfoContainer = document.getElementById('appUserInfo');
            const editForm = document.getElementById('userEditForm');
            container.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';
            appUserInfoContainer.innerHTML = '';
            editForm.style.display = 'none';
            
            try {
                const response = await fetch('/api/me');
                if (!response.ok) throw new Error('API í˜¸ì¶œ ì‹¤íŒ¨');
                
                msCurrentUser = await response.json();
                container.innerHTML = `
                    <div class="user-info">
                        <div class="info-item">
                            <label>ID</label>
                            <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <span id="userIdDisplay" style="display: none; font-family: monospace; word-break: break-all;">${msCurrentUser.id || 'N/A'}</span>
                                <span id="userIdHidden" style="color: #999;">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</span>
                                <button class="btn" onclick="toggleUserId()" style="padding: 5px 10px; font-size: 12px;" id="userIdToggle">ë³´ê¸°</button>
                                <button class="btn" onclick="copyUserId()" style="padding: 5px 10px; font-size: 12px; display: none; background: #28a745;" id="userIdCopy">ë³µì‚¬</button>
                            </div>
                        </div>
                        <div class="info-item">
                            <label>ì´ë¦„</label>
                            <span>${msCurrentUser.displayName || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì´ë©”ì¼</label>
                            <span>${msCurrentUser.mail || msCurrentUser.userPrincipalName || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì§ì±…</label>
                            <span>${msCurrentUser.jobTitle || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ë¶€ì„œ</label>
                            <span>${msCurrentUser.department || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì‚¬ë¬´ì‹¤</label>
                            <span>${msCurrentUser.officeLocation || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì „í™”</label>
                            <span>${msCurrentUser.businessPhones && msCurrentUser.businessPhones.length > 0 ? msCurrentUser.businessPhones[0] : 'N/A'}</span>
                        </div>
                        
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<div class="error">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }
        
        // ìˆ˜ì • í¼ í‘œì‹œ
        async function showEditForm() {
            const container = document.getElementById('userInfo');
            const appUserInfoContainer = document.getElementById('appUserInfo');
            const editForm = document.getElementById('userEditForm');
            
            // ì•± ì‚¬ìš©ì ì •ë³´ ìˆ¨ê¸°ê¸°
            appUserInfoContainer.innerHTML = '';
            
            editForm.innerHTML = `
                <div class="section" style="margin-top: 20px; background: #f9f9f9;">
                    <h3>ì •ë³´ ìˆ˜ì •</h3>
                    <div class="input-group">
                        <label style="width: 150px; display: inline-block;">ì´ë¦„:</label>
                        <input type="text" id="editDisplayName" value="${msCurrentUser.displayName || ''}" style="flex: 1;">
                    </div>
                    <div class="input-group">
                        <label style="width: 150px; display: inline-block;">ì§ì±…:</label>
                        <input type="text" id="editJobTitle" value="${msCurrentUser.jobTitle || ''}" style="flex: 1;">
                    </div>
                    <div class="input-group">
                        <label style="width: 150px; display: inline-block;">ë¶€ì„œ:</label>
                        <input type="text" id="editDepartment" value="${msCurrentUser.department || ''}" style="flex: 1;">
                    </div>
                    <div class="input-group">
                        <label style="width: 150px; display: inline-block;">ì‚¬ë¬´ì‹¤:</label>
                        <input type="text" id="editOfficeLocation" value="${msCurrentUser.officeLocation || ''}" style="flex: 1;">
                    </div>
                    <div class="input-group">
                        <label style="width: 150px; display: inline-block;">ì „í™”:</label>
                        <input type="text" id="editBusinessPhone" value="${msCurrentUser.businessPhones && msCurrentUser.businessPhones.length > 0 ? msCurrentUser.businessPhones[0] : ''}" style="flex: 1;">
                    </div>
                    <div class="input-group">
                        <button class="btn" onclick="updateUserInfo()">ì €ì¥</button>
                        <button class="btn" onclick="cancelEdit()" style="background: #999;">ì·¨ì†Œ</button>
                    </div>
                    <div id="updateResult"></div>
                </div>
            `;
            editForm.style.display = 'block';
        }
        
        // ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •
        async function updateUserInfo() {
            const resultContainer = document.getElementById('updateResult');
            resultContainer.innerHTML = '<div class="loading">ì €ì¥ ì¤‘...</div>';
            
            try {
                // ë¹ˆ ë¬¸ìì—´ì€ nullë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡í•˜ì§€ ì•ŠìŒ
                const updateData = {};
                const displayName = document.getElementById('editDisplayName').value.trim();
                const jobTitle = document.getElementById('editJobTitle').value.trim();
                const department = document.getElementById('editDepartment').value.trim();
                const officeLocation = document.getElementById('editOfficeLocation').value.trim();
                const businessPhone = document.getElementById('editBusinessPhone').value.trim();
                
                if (displayName) updateData.displayName = displayName;
                if (jobTitle) updateData.jobTitle = jobTitle;
                if (department) updateData.department = department;
                if (officeLocation) updateData.officeLocation = officeLocation;
                if (businessPhone) updateData.businessPhone = businessPhone;
                
                // ì—…ë°ì´íŠ¸í•  í•„ë“œê°€ ì—†ìœ¼ë©´ ê²½ê³ 
                if (Object.keys(updateData).length === 0) {
                    resultContainer.innerHTML = '<div class="error">ìˆ˜ì •í•  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
                
                const response = await fetch('/api/me', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                // ì‘ë‹µ ë³¸ë¬¸ í™•ì¸
                const responseText = await response.text();
                
                if (!response.ok) {
                    let errorMessage = 'API í˜¸ì¶œ ì‹¤íŒ¨';
                    try {
                        if (responseText) {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.message || errorMessage;
                        }
                    } catch (e) {
                        errorMessage = responseText || `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                // ì„±ê³µ ì‘ë‹µ ì²˜ë¦¬
                let updatedUser = null;
                if (responseText && responseText.trim()) {
                    try {
                        updatedUser = JSON.parse(responseText);
                        msCurrentUser = updatedUser;
                    } catch (e) {
                        console.warn('ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨, ì‚¬ìš©ì ì •ë³´ ë‹¤ì‹œ ë¡œë“œ:', e);
                        // íŒŒì‹± ì‹¤íŒ¨í•´ë„ ì‚¬ìš©ì ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
                    }
                }
                
                resultContainer.innerHTML = '<div style="color: green; padding: 10px;">âœ… ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
                
                // 1ì´ˆ í›„ ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
                setTimeout(() => {
                    loadUserInfo();
                    document.getElementById('userEditForm').style.display = 'none';
                }, 1000);
                
            } catch (error) {
                resultContainer.innerHTML = `<div class="error">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }
        
        // ìˆ˜ì • ì·¨ì†Œ
        function cancelEdit() {
            document.getElementById('userEditForm').style.display = 'none';
            document.getElementById('updateResult').innerHTML = '';
        }
        
        // ID ë³´ê¸°/ìˆ¨ê¸°ê¸° í† ê¸€
        function toggleUserId() {
            const display = document.getElementById('userIdDisplay');
            const hidden = document.getElementById('userIdHidden');
            const toggle = document.getElementById('userIdToggle');
            const copyBtn = document.getElementById('userIdCopy');
            
            if (display.style.display === 'none') {
                display.style.display = 'inline';
                hidden.style.display = 'none';
                toggle.textContent = 'ìˆ¨ê¸°ê¸°';
                copyBtn.style.display = 'inline-block';
            } else {
                display.style.display = 'none';
                hidden.style.display = 'inline';
                toggle.textContent = 'ë³´ê¸°';
                copyBtn.style.display = 'none';
            }
        }
        
        // ID ë³µì‚¬
        async function copyUserId() {
            const userId = msCurrentUser?.id;
            if (!userId) {
                alert('ë³µì‚¬í•  IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(userId);
                const copyBtn = document.getElementById('userIdCopy');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = 'ë³µì‚¬ë¨!';
                copyBtn.style.background = '#28a745';
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.style.background = '#28a745';
                }, 2000);
            } catch (err) {
                // í´ë¦½ë³´ë“œ APIê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê²½ìš° ëŒ€ì²´ ë°©ë²•
                const textArea = document.createElement('textarea');
                textArea.value = userId;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    const copyBtn = document.getElementById('userIdCopy');
                    const originalText = copyBtn.textContent;
                    copyBtn.textContent = 'ë³µì‚¬ë¨!';
                    copyBtn.style.background = '#28a745';
                    
                    setTimeout(() => {
                        copyBtn.textContent = originalText;
                        copyBtn.style.background = '#28a745';
                    }, 2000);
                } catch (e) {
                    alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
                } finally {
                    document.body.removeChild(textArea);
                }
            }
        }
        
        // ì•±(DB) ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        async function loadAppUserInfo() {
            const container = document.getElementById('appUserInfo');
            const userInfoContainer = document.getElementById('userInfo');
            const editForm = document.getElementById('userEditForm');
            container.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';
            userInfoContainer.innerHTML = '';
            editForm.style.display = 'none';
            
            try {
                const response = await fetch('/api/app/me');
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'API í˜¸ì¶œ ì‹¤íŒ¨');
                }
                
                const appCurrentUser = await response.json();
                container.innerHTML = `
                    <div class="user-info" style="margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                        <div class="info-item">
                            <label>ì‚¬ìš©ì ID</label>
                            <span style="font-family: monospace;">${appCurrentUser.id || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì´ë©”ì¼</label>
                            <span>${appCurrentUser.email || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ì´ë¦„</label>
                            <span>${appCurrentUser.name || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ë¡œê·¸ì¸ íƒ€ì…</label>
                            <span>${appCurrentUser.loginType || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>Microsoft ID</label>
                            <span style="font-family: monospace; word-break: break-all;">${appCurrentUser.microsoftId || 'ì—°ë™ ì•ˆ ë¨'}</span>
                        </div>
                        <div class="info-item">
                            <label>Microsoft Principal Name</label>
                            <span>${appCurrentUser.userPrincipalName || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>OAuth ì—°ë™ ì—¬ë¶€</label>
                            <span>${appCurrentUser.oauthLinked ? 'âœ… ì—°ë™ë¨' : 'âŒ ë¯¸ì—°ë™'}</span>
                        </div>
                        <div class="info-item">
                            <label>ê³„ì • ìƒì„±ì¼</label>
                            <span>${appCurrentUser.createdAt || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</label>
                            <span>${appCurrentUser.lastLoginAt || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <label>OAuth ì—°ë™ì¼</label>
                            <span>${appCurrentUser.oauthLinkedAt || 'N/A'}</span>
                        </div>
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `<div class="error">ì˜¤ë¥˜: ${error.message}</div>`;
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        window.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();
        });
    </script>
</body>
</html>

